<!DOCTYPE html>
<html>
<head>
  <title>MoonSnake Payment Redirect</title>
</head>
<body>
  <script>
    // Extract URL parameters and put them into an object
    function getParams() {
        var params = {};
        window.location.search.substring(1).split("&").forEach(function (part) {
            var item = part.split("=");
            params[item[0]] = decodeURIComponent(item[1]);
        });
        return params;
    }

    // Send the parameters to the opener window
    var params = getParams();

    var status = params['status'];

    console.log('opener: ' + (window.opener?.location?.href ?? 'null'));
    
    if (window.opener != null && !window.opener.closed) {

        // Temporary work-around because of Banxa checkout bug. We are polling the status of the payment
        // using the order ID in the main app, but this would be better if we could get the post message
        // callback to work.
        if (status == null) {
          status = 'unknown';
        }

        // Send the parameters to the opener window
        window.opener.postMessage({ type: 'PAYMENT-STATUS', status: status, params: params }, '*');

        // Change back to the opener tab
        window.opener.focus();

        // Close this tab
        window.close();
    } else {
        // Navigate to the home page as a fallback
        window.location.href = 'https://app.moonsnake.org/';
    }
  </script>
</body>
</html>